# üéØ PLANO: Adicionar 7 Nutrientes Essenciais (Tier 1)

**Data de Cria√ß√£o**: 18/10/2025, 14:10
**Data de Atualiza√ß√£o**: 18/10/2025, 14:10
**Status**: üìã Planejamento Completo
**Objetivo**: Adicionar rastreamento de 7 nutrientes essenciais de forma segura e incremental

---

## üìä Contexto

### Situa√ß√£o Atual
- ‚úÖ Rastreamos 7 nutrientes b√°sicos: calories, protein_g, carbs_g, fat_g, fiber_g, sodium_mg, sugar_g
- ‚úÖ `saturated_fat` existe APENAS na tabela `food_bank`
- ‚ùå V√°rios nutrientes importantes N√ÉO s√£o rastreados em refei√ß√µes
- ‚úÖ Sistema j√° funciona bem, mas incompleto

### Por que adicionar AGORA?
1. **Momento ideal**: Pouco dado no sistema ainda (migra√ß√£o simples)
2. **Sa√∫de completa**: Rastrear defici√™ncias e excessos importantes
3. **Profissionalismo**: Sistema completo e competitivo
4. **Uma migra√ß√£o s√≥**: Melhor fazer tudo de uma vez
5. **Diferencial**: Poucos apps rastreiam isso tudo

---

## üéØ Objetivo

### Adicionar 7 Nutrientes Essenciais (Tier 1):

1. ‚úÖ **Gordura Saturada** (saturated_fat_g) - Sa√∫de cardiovascular
2. ‚úÖ **Gordura Trans** (trans_fat_g) - Altamente prejudicial
3. ‚úÖ **Colesterol** (cholesterol_mg) - Sa√∫de card√≠aca
4. ‚úÖ **C√°lcio** (calcium_mg) - Sa√∫de √≥ssea
5. ‚úÖ **Ferro** (iron_mg) - Preven√ß√£o de anemia
6. ‚úÖ **Pot√°ssio** (potassium_mg) - Press√£o arterial
7. ‚úÖ **Vitamina D** (vitamin_d_mcg) - Defici√™ncia muito comum

### Onde adicionar:
- ‚úÖ Tabela `nutrition_data` (refei√ß√µes)
- ‚úÖ Tabela `food_bank` (banco de alimentos)
- ‚úÖ Interface de captura `/capture`
- ‚úÖ Interface `/meus-alimentos`
- ‚úÖ An√°lise de IA
- ‚úÖ Reposit√≥rios e APIs

**SEM QUEBRAR NADA DO QUE J√Å FUNCIONA**

---

## üîç An√°lise de Impacto

### Arquivos que PRECISAM ser modificados:

1. **Banco de Dados** (1 arquivo)
   - `migrations/014_add_tier1_nutrients.sql` (NOVO)

2. **Types/Schemas** (3 arquivos)
   - `lib/ai.ts` - tipo `AiFood`
   - `lib/schemas/meal.ts` - schema de valida√ß√£o
   - `lib/repos/meal.repo.ts` - tipo `DbFoodItem` e queries
   - `lib/repos/food-bank.repo.ts` - queries

3. **APIs** (3 arquivos)
   - `app/api/meals/analyze-meal/route.ts` - passar para IA
   - `app/api/meals/approve/route.ts` - salvar no banco
   - `app/api/food-bank/route.ts` - criar/atualizar alimentos

4. **Frontend** (2 arquivos)
   - `app/capture/page.tsx` - adicionar 7 campos edit√°veis
   - `app/meus-alimentos/page.tsx` - adicionar 7 campos

### Arquivos que N√ÉO precisam mudar (por enquanto):
- ‚ùå Dashboard (pode usar valores se existirem)
- ‚ùå Relat√≥rios (podem incluir depois)
- ‚ùå Hist√≥rico (j√° mostra o que existe)

---

## üìã PLANO DE EXECU√á√ÉO (7 ETAPAS)

### üî∑ ETAPA 1: Criar e Aplicar Migra√ß√£o no Banco
**Objetivo**: Adicionar 7 colunas nas tabelas `nutrition_data` e `food_bank`

#### Passos:
1. Criar arquivo `migrations/014_add_tier1_nutrients.sql`
2. Migra√ß√£o deve ser ADITIVA (n√£o remove nada)
3. Todas as colunas devem ser NULLABLE (n√£o quebra dados existentes)
4. Testar localmente primeiro

#### C√≥digo da Migra√ß√£o:

```sql
-- Migration #014: Add Tier 1 Essential Nutrients
-- Date: 18/10/2025
-- Description: Add 7 essential nutrients to nutrition tracking
-- SAFE: Additive only, nullable columns, backwards compatible

-- ============================================================
-- PART 1: Update nutrition_data (meals)
-- ============================================================

ALTER TABLE nutrition_data
ADD COLUMN saturated_fat_g NUMERIC(10,2) NULL,
ADD COLUMN trans_fat_g NUMERIC(10,2) NULL,
ADD COLUMN cholesterol_mg NUMERIC(10,2) NULL,
ADD COLUMN calcium_mg NUMERIC(10,2) NULL,
ADD COLUMN iron_mg NUMERIC(10,2) NULL,
ADD COLUMN potassium_mg NUMERIC(10,2) NULL,
ADD COLUMN vitamin_d_mcg NUMERIC(10,2) NULL;

-- Add comments
COMMENT ON COLUMN nutrition_data.saturated_fat_g IS 'Gordura saturada em gramas';
COMMENT ON COLUMN nutrition_data.trans_fat_g IS 'Gordura trans em gramas';
COMMENT ON COLUMN nutrition_data.cholesterol_mg IS 'Colesterol em miligramas';
COMMENT ON COLUMN nutrition_data.calcium_mg IS 'C√°lcio em miligramas';
COMMENT ON COLUMN nutrition_data.iron_mg IS 'Ferro em miligramas';
COMMENT ON COLUMN nutrition_data.potassium_mg IS 'Pot√°ssio em miligramas';
COMMENT ON COLUMN nutrition_data.vitamin_d_mcg IS 'Vitamina D em microgramas';

-- ============================================================
-- PART 2: Update food_bank (user's food database)
-- ============================================================
-- Note: saturated_fat already exists in food_bank, so we skip it

ALTER TABLE food_bank
ADD COLUMN trans_fat NUMERIC(10,2) NULL,
ADD COLUMN cholesterol NUMERIC(10,2) NULL,
ADD COLUMN calcium NUMERIC(10,2) NULL,
ADD COLUMN iron NUMERIC(10,2) NULL,
ADD COLUMN potassium NUMERIC(10,2) NULL,
ADD COLUMN vitamin_d NUMERIC(10,2) NULL;

-- Add comments
COMMENT ON COLUMN food_bank.trans_fat IS 'Gordura trans em gramas';
COMMENT ON COLUMN food_bank.cholesterol IS 'Colesterol em miligramas';
COMMENT ON COLUMN food_bank.calcium IS 'C√°lcio em miligramas';
COMMENT ON COLUMN food_bank.iron IS 'Ferro em miligramas';
COMMENT ON COLUMN food_bank.potassium IS 'Pot√°ssio em miligramas';
COMMENT ON COLUMN food_bank.vitamin_d IS 'Vitamina D em microgramas';

-- ============================================================
-- VERIFICATION QUERIES (optional, for testing)
-- ============================================================

-- Verify nutrition_data columns
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'nutrition_data'
  AND column_name IN (
    'saturated_fat_g', 'trans_fat_g', 'cholesterol_mg',
    'calcium_mg', 'iron_mg', 'potassium_mg', 'vitamin_d_mcg'
  )
ORDER BY column_name;

-- Verify food_bank columns
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'food_bank'
  AND column_name IN (
    'saturated_fat', 'trans_fat', 'cholesterol',
    'calcium', 'iron', 'potassium', 'vitamin_d'
  )
ORDER BY column_name;
```

#### Teste desta etapa:
```bash
# 1. Executar migra√ß√£o
npx dotenv-cli -e .env.local -- npx tsx scripts/apply-migrations.ts

# 2. Verificar que colunas foram criadas
npx dotenv-cli -e .env.local -- npx tsx scripts/extract-schema.ts

# 3. Verificar em docs/database/CURRENT_SCHEMA.md que os 7 campos aparecem

# 4. TESTAR APP: Tudo deve continuar funcionando normalmente!
# - Capturar foto de refei√ß√£o
# - Aprovar refei√ß√£o
# - Ver no dashboard
# - Cadastrar alimento
```

#### Crit√©rio de Sucesso:
- ‚úÖ Migra√ß√£o aplicada sem erros
- ‚úÖ 7 colunas existem em `nutrition_data`
- ‚úÖ 6 colunas novas existem em `food_bank` (saturated_fat j√° existia)
- ‚úÖ App continua funcionando (refei√ß√µes antigas sem os campos)
- ‚úÖ Nenhum erro no console

#### Rollback se der errado:
```sql
-- nutrition_data
ALTER TABLE nutrition_data
DROP COLUMN saturated_fat_g,
DROP COLUMN trans_fat_g,
DROP COLUMN cholesterol_mg,
DROP COLUMN calcium_mg,
DROP COLUMN iron_mg,
DROP COLUMN potassium_mg,
DROP COLUMN vitamin_d_mcg;

-- food_bank
ALTER TABLE food_bank
DROP COLUMN trans_fat,
DROP COLUMN cholesterol,
DROP COLUMN calcium,
DROP COLUMN iron,
DROP COLUMN potassium,
DROP COLUMN vitamin_d;
```

---

### üî∑ ETAPA 2: Atualizar Type `AiFood` (lib/ai.ts)
**Objetivo**: IA saber que pode retornar os 7 novos nutrientes

#### Modifica√ß√£o em `lib/ai.ts`:

```typescript
// ANTES:
export type AiFood = {
  name: string;
  quantity: number;
  unit: string;
  calories?: number;
  protein_g?: number;
  carbs_g?: number;
  fat_g?: number;
  fiber_g?: number;
  sodium_mg?: number;
  sugar_g?: number;
};

// DEPOIS:
export type AiFood = {
  name: string;
  quantity: number;
  unit: string;
  calories?: number;
  protein_g?: number;
  carbs_g?: number;
  fat_g?: number;
  fiber_g?: number;
  sodium_mg?: number;
  sugar_g?: number;
  saturated_fat_g?: number;     // üÜï NOVO
  trans_fat_g?: number;          // üÜï NOVO
  cholesterol_mg?: number;       // üÜï NOVO
  calcium_mg?: number;           // üÜï NOVO
  iron_mg?: number;              // üÜï NOVO
  potassium_mg?: number;         // üÜï NOVO
  vitamin_d_mcg?: number;        // üÜï NOVO
};
```

#### Teste desta etapa:
```bash
# 1. Compilar TypeScript
npm run build

# 2. Verificar que n√£o h√° erros de tipo
# 3. App deve continuar funcionando
```

#### Crit√©rio de Sucesso:
- ‚úÖ TypeScript compila sem erros
- ‚úÖ App continua funcionando
- ‚úÖ Nenhum erro no console

---

### üî∑ ETAPA 3: Atualizar Prompts da IA
**Objetivo**: IA come√ßar a retornar os 7 novos nutrientes

#### 3A - Modificar `app/api/meals/analyze-meal/route.ts` (linha ~50):

**ANTES**:
```typescript
return `${f.name} (${f.quantity} ${f.unit}) - Do banco de alimentos: ${f.calories} kcal, ${f.protein_g}g prote√≠na, ${f.carbs_g}g carboidrato, ${f.fat_g}g gordura, ${f.fiber_g}g fibras, ${f.sodium_mg}mg s√≥dio, ${f.sugar_g}g a√ß√∫car`;
```

**DEPOIS**:
```typescript
const parts = [
  `${f.name} (${f.quantity} ${f.unit}) - Do banco de alimentos:`,
  `${f.calories} kcal`,
  `${f.protein_g}g prote√≠na`,
  `${f.carbs_g}g carboidrato`,
  `${f.fat_g}g gordura`
];

// Adiciona nutrientes se existirem
if (f.fiber_g !== undefined && f.fiber_g !== null) {
  parts.push(`${f.fiber_g}g fibras`);
}
if (f.sodium_mg !== undefined && f.sodium_mg !== null) {
  parts.push(`${f.sodium_mg}mg s√≥dio`);
}
if (f.sugar_g !== undefined && f.sugar_g !== null) {
  parts.push(`${f.sugar_g}g a√ß√∫car`);
}
// üÜï NOVOS NUTRIENTES
if (f.saturated_fat !== undefined && f.saturated_fat !== null) {
  parts.push(`${f.saturated_fat}g gordura saturada`);
}
if (f.trans_fat !== undefined && f.trans_fat !== null) {
  parts.push(`${f.trans_fat}g gordura trans`);
}
if (f.cholesterol !== undefined && f.cholesterol !== null) {
  parts.push(`${f.cholesterol}mg colesterol`);
}
if (f.calcium !== undefined && f.calcium !== null) {
  parts.push(`${f.calcium}mg c√°lcio`);
}
if (f.iron !== undefined && f.iron !== null) {
  parts.push(`${f.iron}mg ferro`);
}
if (f.potassium !== undefined && f.potassium !== null) {
  parts.push(`${f.potassium}mg pot√°ssio`);
}
if (f.vitamin_d !== undefined && f.vitamin_d !== null) {
  parts.push(`${f.vitamin_d}mcg vitamina D`);
}

return parts.join(', ');
```

#### 3B - Atualizar exemplo JSON no prompt (linha ~65):

**ADICIONAR no exemplo**:
```typescript
{
  "name": "Arroz",
  "quantity": 2,
  "unit": "colheres",
  "calories": 130,
  "protein_g": 2.7,
  "carbs_g": 28,
  "fat_g": 0.3,
  "fiber_g": 0.4,
  "sodium_mg": 1,
  "sugar_g": 0.1,
  "saturated_fat_g": 0.1,      // üÜï ADICIONAR
  "trans_fat_g": 0,            // üÜï ADICIONAR
  "cholesterol_mg": 0,         // üÜï ADICIONAR
  "calcium_mg": 10,            // üÜï ADICIONAR
  "iron_mg": 0.2,              // üÜï ADICIONAR
  "potassium_mg": 35,          // üÜï ADICIONAR
  "vitamin_d_mcg": 0           // üÜï ADICIONAR
}
```

#### 3C - Atualizar an√°lise de r√≥tulos `lib/ai/nutrition-label-analyzer.ts`:

Adicionar instru√ß√µes para extrair os 7 novos campos no prompt.

#### Teste desta etapa:
```bash
# 1. Testar an√°lise de refei√ß√£o (foto ou texto)
# 2. Verificar no console do navegador o JSON retornado pela IA
# 3. Verificar se os novos campos aparecem (podem ser null/0)
# 4. App deve continuar funcionando
```

#### Crit√©rio de Sucesso:
- ‚úÖ IA retorna os novos campos (mesmo que 0 ou null)
- ‚úÖ An√°lise continua funcionando
- ‚úÖ Nenhum erro no console

---

### üî∑ ETAPA 4: Adicionar Campos no Frontend `/capture`
**Objetivo**: Usu√°rio poder visualizar e editar os 7 nutrientes

#### Modifica√ß√£o em `app/capture/page.tsx`:

**Reorganizar campos por CATEGORIAS** (depois de `sugar_g`, linha ~784):

```tsx
{/* CATEGORIAS ORGANIZADAS */}

{/* 1. MACRONUTRIENTES PRINCIPAIS - j√° existem */}
<div style={{...}}>
  <h4>Macronutrientes Principais</h4>
  {/* calories, protein_g, carbs_g, fat_g */}
</div>

{/* 2. üÜï GORDURAS DETALHADAS */}
<div style={{ marginTop: 20 }}>
  <h4 style={{
    fontSize: 14,
    fontWeight: 700,
    color: '#6b7280',
    marginBottom: 12,
    textTransform: 'uppercase',
    letterSpacing: '0.5px'
  }}>
    üßà Gorduras Detalhadas
  </h4>
  <div style={{
    display: 'grid',
    gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
    gap: 12
  }}>
    {/* Gordura Saturada */}
    <div>
      <label style={{ fontSize: 12, color: '#666', display: 'block', marginBottom: 4 }}>
        üî¥ Gord. Sat. (g)
      </label>
      <input
        type="number"
        step="0.1"
        value={food.saturated_fat_g || ''}
        onChange={e => {
          const updated = [...analysis.foods];
          updated[i].saturated_fat_g = Number(e.target.value) || undefined;
          setAnalysis({ ...analysis, foods: updated });
        }}
        style={{
          width: '100%',
          padding: '6px 8px',
          fontSize: 14,
          border: '1px solid #d1d5db',
          borderRadius: 6,
          outline: 'none',
          boxSizing: 'border-box'
        }}
        placeholder="0"
      />
    </div>

    {/* Gordura Trans */}
    <div>
      <label style={{ fontSize: 12, color: '#666', display: 'block', marginBottom: 4 }}>
        ‚ö†Ô∏è Gord. Trans (g)
      </label>
      <input
        type="number"
        step="0.1"
        value={food.trans_fat_g || ''}
        onChange={e => {
          const updated = [...analysis.foods];
          updated[i].trans_fat_g = Number(e.target.value) || undefined;
          setAnalysis({ ...analysis, foods: updated });
        }}
        style={{
          width: '100%',
          padding: '6px 8px',
          fontSize: 14,
          border: '1px solid #d1d5db',
          borderRadius: 6,
          outline: 'none',
          boxSizing: 'border-box'
        }}
        placeholder="0"
      />
    </div>

    {/* Colesterol */}
    <div>
      <label style={{ fontSize: 12, color: '#666', display: 'block', marginBottom: 4 }}>
        üíä Colesterol (mg)
      </label>
      <input
        type="number"
        step="1"
        value={food.cholesterol_mg || ''}
        onChange={e => {
          const updated = [...analysis.foods];
          updated[i].cholesterol_mg = Number(e.target.value) || undefined;
          setAnalysis({ ...analysis, foods: updated });
        }}
        style={{
          width: '100%',
          padding: '6px 8px',
          fontSize: 14,
          border: '1px solid #d1d5db',
          borderRadius: 6,
          outline: 'none',
          boxSizing: 'border-box'
        }}
        placeholder="0"
      />
    </div>
  </div>
</div>

{/* 3. CARBOIDRATOS E FIBRAS - j√° existem */}
<div style={{ marginTop: 20 }}>
  <h4>üåæ Carboidratos e Fibras</h4>
  {/* fiber_g, sugar_g */}
</div>

{/* 4. üÜï MINERAIS */}
<div style={{ marginTop: 20 }}>
  <h4 style={{
    fontSize: 14,
    fontWeight: 700,
    color: '#6b7280',
    marginBottom: 12,
    textTransform: 'uppercase',
    letterSpacing: '0.5px'
  }}>
    ‚öõÔ∏è Minerais Essenciais
  </h4>
  <div style={{
    display: 'grid',
    gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
    gap: 12
  }}>
    {/* C√°lcio */}
    <div>
      <label style={{ fontSize: 12, color: '#666', display: 'block', marginBottom: 4 }}>
        ü¶¥ C√°lcio (mg)
      </label>
      <input
        type="number"
        step="1"
        value={food.calcium_mg || ''}
        onChange={e => {
          const updated = [...analysis.foods];
          updated[i].calcium_mg = Number(e.target.value) || undefined;
          setAnalysis({ ...analysis, foods: updated });
        }}
        style={{
          width: '100%',
          padding: '6px 8px',
          fontSize: 14,
          border: '1px solid #d1d5db',
          borderRadius: 6,
          outline: 'none',
          boxSizing: 'border-box'
        }}
        placeholder="0"
      />
    </div>

    {/* Ferro */}
    <div>
      <label style={{ fontSize: 12, color: '#666', display: 'block', marginBottom: 4 }}>
        ü©∏ Ferro (mg)
      </label>
      <input
        type="number"
        step="0.1"
        value={food.iron_mg || ''}
        onChange={e => {
          const updated = [...analysis.foods];
          updated[i].iron_mg = Number(e.target.value) || undefined;
          setAnalysis({ ...analysis, foods: updated });
        }}
        style={{
          width: '100%',
          padding: '6px 8px',
          fontSize: 14,
          border: '1px solid #d1d5db',
          borderRadius: 6,
          outline: 'none',
          boxSizing: 'border-box'
        }}
        placeholder="0"
      />
    </div>

    {/* Pot√°ssio */}
    <div>
      <label style={{ fontSize: 12, color: '#666', display: 'block', marginBottom: 4 }}>
        üíö Pot√°ssio (mg)
      </label>
      <input
        type="number"
        step="1"
        value={food.potassium_mg || ''}
        onChange={e => {
          const updated = [...analysis.foods];
          updated[i].potassium_mg = Number(e.target.value) || undefined;
          setAnalysis({ ...analysis, foods: updated });
        }}
        style={{
          width: '100%',
          padding: '6px 8px',
          fontSize: 14,
          border: '1px solid #d1d5db',
          borderRadius: 6,
          outline: 'none',
          boxSizing: 'border-box'
        }}
        placeholder="0"
      />
    </div>
  </div>
</div>

{/* 5. üÜï VITAMINAS E OUTROS */}
<div style={{ marginTop: 20 }}>
  <h4 style={{
    fontSize: 14,
    fontWeight: 700,
    color: '#6b7280',
    marginBottom: 12,
    textTransform: 'uppercase',
    letterSpacing: '0.5px'
  }}>
    üíä Vitaminas e Outros
  </h4>
  <div style={{
    display: 'grid',
    gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
    gap: 12
  }}>
    {/* S√≥dio - j√° existe, mover para c√° */}
    <div>
      <label style={{ fontSize: 12, color: '#666', display: 'block', marginBottom: 4 }}>
        üßÇ S√≥dio (mg)
      </label>
      {/* ... c√≥digo existente ... */}
    </div>

    {/* Vitamina D */}
    <div>
      <label style={{ fontSize: 12, color: '#666', display: 'block', marginBottom: 4 }}>
        ‚òÄÔ∏è Vitamina D (mcg)
      </label>
      <input
        type="number"
        step="0.1"
        value={food.vitamin_d_mcg || ''}
        onChange={e => {
          const updated = [...analysis.foods];
          updated[i].vitamin_d_mcg = Number(e.target.value) || undefined;
          setAnalysis({ ...analysis, foods: updated });
        }}
        style={{
          width: '100%',
          padding: '6px 8px',
          fontSize: 14,
          border: '1px solid #d1d5db',
          borderRadius: 6,
          outline: 'none',
          boxSizing: 'border-box'
        }}
        placeholder="0"
      />
    </div>
  </div>
</div>
```

#### Teste desta etapa:
```bash
# 1. Capturar foto de refei√ß√£o
# 2. Verificar que TODAS as categorias aparecem:
#    - Macronutrientes Principais (4 campos)
#    - Gorduras Detalhadas (3 campos) üÜï
#    - Carboidratos e Fibras (2 campos)
#    - Minerais Essenciais (3 campos) üÜï
#    - Vitaminas e Outros (2 campos) üÜï
# 3. Editar valores manualmente
# 4. Verificar que valores s√£o mantidos
# 5. N√ÉO APROVAR ainda (pr√≥xima etapa)
```

#### Crit√©rio de Sucesso:
- ‚úÖ 14 campos aparecem na tela (7 antigos + 7 novos)
- ‚úÖ Organizados em 5 categorias
- ‚úÖ Pode editar todos os valores
- ‚úÖ Valores s√£o mantidos no estado
- ‚úÖ CSS responsivo (n√£o vaza em mobile)

---

### üî∑ ETAPA 5: Atualizar Schema de Valida√ß√£o
**Objetivo**: Validar que os 7 novos campos s√£o aceitos

#### Modificar `lib/schemas/meal.ts`:

```typescript
const FoodItemSchema = z.object({
  name: z.string(),
  quantity: z.number(),
  unit: z.string(),
  calories: z.number().optional(),
  protein_g: z.number().optional(),
  carbs_g: z.number().optional(),
  fat_g: z.number().optional(),
  fiber_g: z.number().optional(),
  sodium_mg: z.number().optional(),
  sugar_g: z.number().optional(),
  saturated_fat_g: z.number().optional(),   // üÜï
  trans_fat_g: z.number().optional(),       // üÜï
  cholesterol_mg: z.number().optional(),    // üÜï
  calcium_mg: z.number().optional(),        // üÜï
  iron_mg: z.number().optional(),           // üÜï
  potassium_mg: z.number().optional(),      // üÜï
  vitamin_d_mcg: z.number().optional()      // üÜï
});
```

#### Teste desta etapa:
```bash
# 1. Verificar que TypeScript compila
# 2. Tentar aprovar refei√ß√£o (pode falhar ainda, normal)
# 3. Verificar mensagem de erro (deve ser clara)
```

#### Crit√©rio de Sucesso:
- ‚úÖ TypeScript compila
- ‚úÖ Schema aceita os novos campos
- ‚úÖ Valida√ß√£o funciona

---

### üî∑ ETAPA 6: Salvar no Banco (APIs + Repos)
**Objetivo**: Persistir os 7 nutrientes no banco de dados

#### 6.1 - Modificar `app/api/meals/approve/route.ts` (linha ~69):

```typescript
foods: data.foods.map((f: any) => ({
  name: f.name,
  quantity: f.quantity,
  unit: f.unit,
  calories: f.calories ?? undefined,
  protein_g: f.protein_g ?? undefined,
  carbs_g: f.carbs_g ?? undefined,
  fat_g: f.fat_g ?? undefined,
  fiber_g: f.fiber_g ?? undefined,
  sodium_mg: f.sodium_mg ?? undefined,
  sugar_g: f.sugar_g ?? undefined,
  saturated_fat_g: f.saturated_fat_g ?? undefined,     // üÜï
  trans_fat_g: f.trans_fat_g ?? undefined,             // üÜï
  cholesterol_mg: f.cholesterol_mg ?? undefined,       // üÜï
  calcium_mg: f.calcium_mg ?? undefined,               // üÜï
  iron_mg: f.iron_mg ?? undefined,                     // üÜï
  potassium_mg: f.potassium_mg ?? undefined,           // üÜï
  vitamin_d_mcg: f.vitamin_d_mcg ?? undefined          // üÜï
}))
```

#### 6.2 - Modificar `lib/repos/meal.repo.ts`:

**A) Tipo (linha ~38)**:
```typescript
foods: Array<{
  name: string;
  quantity: number;
  unit: string;
  calories?: number;
  confidence?: number;
  protein_g?: number;
  carbs_g?: number;
  fat_g?: number;
  fiber_g?: number;
  sodium_mg?: number;
  sugar_g?: number;
  saturated_fat_g?: number;      // üÜï
  trans_fat_g?: number;          // üÜï
  cholesterol_mg?: number;       // üÜï
  calcium_mg?: number;           // üÜï
  iron_mg?: number;              // üÜï
  potassium_mg?: number;         // üÜï
  vitamin_d_mcg?: number;        // üÜï
}>;
```

**B) Condi√ß√£o hasAny (linha ~82)**:
```typescript
const hasAny = (
  typeof f.calories === 'number' ||
  typeof (f as any).protein_g === 'number' ||
  typeof (f as any).carbs_g === 'number' ||
  typeof (f as any).fat_g === 'number' ||
  typeof (f as any).fiber_g === 'number' ||
  typeof (f as any).sodium_mg === 'number' ||
  typeof (f as any).sugar_g === 'number' ||
  typeof (f as any).saturated_fat_g === 'number' ||    // üÜï
  typeof (f as any).trans_fat_g === 'number' ||        // üÜï
  typeof (f as any).cholesterol_mg === 'number' ||     // üÜï
  typeof (f as any).calcium_mg === 'number' ||         // üÜï
  typeof (f as any).iron_mg === 'number' ||            // üÜï
  typeof (f as any).potassium_mg === 'number' ||       // üÜï
  typeof (f as any).vitamin_d_mcg === 'number'         // üÜï
);
```

**C) Query INSERT (linha ~93)**:
```sql
INSERT INTO nutrition_data (
  food_item_id, tenant_id,
  calories, protein_g, carbs_g, fat_g, fiber_g, sodium_mg, sugar_g,
  saturated_fat_g, trans_fat_g, cholesterol_mg,
  calcium_mg, iron_mg, potassium_mg, vitamin_d_mcg
)
VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16)
ON CONFLICT (food_item_id)
DO UPDATE SET
  calories = COALESCE(EXCLUDED.calories, nutrition_data.calories),
  protein_g = COALESCE(EXCLUDED.protein_g, nutrition_data.protein_g),
  carbs_g = COALESCE(EXCLUDED.carbs_g, nutrition_data.carbs_g),
  fat_g = COALESCE(EXCLUDED.fat_g, nutrition_data.fat_g),
  fiber_g = COALESCE(EXCLUDED.fiber_g, nutrition_data.fiber_g),
  sodium_mg = COALESCE(EXCLUDED.sodium_mg, nutrition_data.sodium_mg),
  sugar_g = COALESCE(EXCLUDED.sugar_g, nutrition_data.sugar_g),
  saturated_fat_g = COALESCE(EXCLUDED.saturated_fat_g, nutrition_data.saturated_fat_g),
  trans_fat_g = COALESCE(EXCLUDED.trans_fat_g, nutrition_data.trans_fat_g),
  cholesterol_mg = COALESCE(EXCLUDED.cholesterol_mg, nutrition_data.cholesterol_mg),
  calcium_mg = COALESCE(EXCLUDED.calcium_mg, nutrition_data.calcium_mg),
  iron_mg = COALESCE(EXCLUDED.iron_mg, nutrition_data.iron_mg),
  potassium_mg = COALESCE(EXCLUDED.potassium_mg, nutrition_data.potassium_mg),
  vitamin_d_mcg = COALESCE(EXCLUDED.vitamin_d_mcg, nutrition_data.vitamin_d_mcg)
```

**D) Par√¢metros (linha ~104)**:
```typescript
[
  foodItem.id,
  args.tenantId,
  f.calories ?? 0,
  (f as any).protein_g ?? 0,
  (f as any).carbs_g ?? 0,
  (f as any).fat_g ?? 0,
  (f as any).fiber_g ?? 0,
  (f as any).sodium_mg ?? null,
  (f as any).sugar_g ?? null,
  (f as any).saturated_fat_g ?? null,      // üÜï
  (f as any).trans_fat_g ?? null,          // üÜï
  (f as any).cholesterol_mg ?? null,       // üÜï
  (f as any).calcium_mg ?? null,           // üÜï
  (f as any).iron_mg ?? null,              // üÜï
  (f as any).potassium_mg ?? null,         // üÜï
  (f as any).vitamin_d_mcg ?? null         // üÜï
]
```

**E) Repetir TUDO para `insertMealWithItemsTx`** (segunda fun√ß√£o)

#### 6.3 - Modificar `app/api/food-bank/route.ts`:

Adicionar os 6 novos campos (saturated_fat j√° existe):
- `createSchema` (linha ~19)
- `updateSchema` (linha ~38)
- Fun√ß√µes POST e PATCH

#### 6.4 - Modificar `lib/repos/food-bank.repo.ts`:

Adicionar os 6 campos nas queries de create/update

#### Teste desta etapa:
```bash
# TESTE COMPLETO END-TO-END:

# 1. Capturar foto de refei√ß√£o
# 2. Verificar que IA retorna os novos campos
# 3. Editar valores se necess√°rio
# 4. Aprovar refei√ß√£o
# 5. Verificar que salvou sem erros
# 6. Verificar no Supabase dashboard que os valores est√£o no banco
# 7. Capturar outra refei√ß√£o SEM preencher novos campos
# 8. Aprovar e verificar que funciona (null)
# 9. Cadastrar alimento no banco com todos os campos
# 10. Usar esse alimento em uma refei√ß√£o
```

#### Crit√©rio de Sucesso:
- ‚úÖ Refei√ß√£o salva COM todos os 7 nutrientes
- ‚úÖ Refei√ß√£o salva SEM os novos campos (vazios)
- ‚úÖ Dados corretos no banco
- ‚úÖ Alimentos do banco com 7 campos
- ‚úÖ Nenhum erro no console
- ‚úÖ Refei√ß√µes antigas continuam funcionando

---

### üî∑ ETAPA 7: Atualizar `/meus-alimentos` + Testes Finais
**Objetivo**: Adicionar os 7 campos no banco de alimentos e testar tudo

#### 7.1 - Modificar `app/meus-alimentos/page.tsx`:

Adicionar os 7 campos em:
- Formul√°rio manual
- Formul√°rio com IA (an√°lise de r√≥tulo)
- Modal de edi√ß√£o

Usar a mesma estrutura de categorias do `/capture`.

#### 7.2 - Testes de Regress√£o Completos:

1. ‚úÖ Cadastrar alimento manual com TODOS os campos
2. ‚úÖ Cadastrar alimento via IA (foto de r√≥tulo)
3. ‚úÖ Editar alimento existente e adicionar novos nutrientes
4. ‚úÖ Capturar refei√ß√£o do banco de alimentos
5. ‚úÖ Capturar refei√ß√£o nova (foto)
6. ‚úÖ Capturar refei√ß√£o manual
7. ‚úÖ Aprovar refei√ß√£o com todos os campos preenchidos
8. ‚úÖ Aprovar refei√ß√£o com campos vazios
9. ‚úÖ Verificar refei√ß√µes antigas (devem continuar vis√≠veis)
10. ‚úÖ Verificar dashboard (n√£o deve quebrar)

#### 7.3 - Documenta√ß√£o:
1. Atualizar `docs/database/CURRENT_SCHEMA.md` (rodar script)
2. Marcar este plano como ‚úÖ CONCLU√çDO
3. Atualizar `TECHNICAL_DOCUMENTATION.md`

---

## üö® Pontos de Aten√ß√£o (CUIDADO!)

### ‚ö†Ô∏è Riscos e Como Mitigar:

1. **Migra√ß√£o falhar**
   - ‚úÖ Migra√ß√£o √© ADITIVA (n√£o remove nada)
   - ‚úÖ Todas as colunas s√£o NULLABLE
   - ‚úÖ Testar em local primeiro
   - ‚úÖ Ter rollback pronto

2. **TypeScript n√£o compilar**
   - ‚úÖ Todos os campos OPTIONAL (`?`)
   - ‚úÖ Testar build antes de commit

3. **Query SQL com n√∫mero errado de par√¢metros**
   - ‚úÖ Contar os `$1, $2, ...` vs. array
   - ‚úÖ Testar inser√ß√£o real no banco

4. **Refei√ß√µes antigas quebrarem**
   - ‚úÖ Campos NULLABLE no banco
   - ‚úÖ Campos OPTIONAL no TypeScript
   - ‚úÖ Usar `?? null` em queries

5. **Interface muito polu√≠da**
   - ‚úÖ Organizados em 5 categorias
   - ‚úÖ Se√ß√µes com t√≠tulos claros
   - ‚úÖ Grid responsivo

6. **IA n√£o preencher tudo**
   - ‚úÖ Campos OPTIONAL
   - ‚úÖ Aceita null/undefined
   - ‚úÖ Usu√°rio edita manualmente

---

## üìù Checklist de Seguran√ßa

Antes de cada commit:

- [ ] TypeScript compila sem erros
- [ ] Next.js inicia sem erros
- [ ] Nenhum erro no console
- [ ] Testar fluxo completo (foto ‚Üí an√°lise ‚Üí aprova√ß√£o)
- [ ] Testar com campos vazios
- [ ] Testar com campos preenchidos
- [ ] Verificar banco de dados
- [ ] Refei√ß√µes antigas funcionam
- [ ] Banco de alimentos funciona

---

## üéØ Ordem de Execu√ß√£o

```
ETAPA 1: Migra√ß√£o (7 colunas)
   ‚Üì TESTAR
ETAPA 2: Types (AiFood)
   ‚Üì TESTAR
ETAPA 3: Prompts IA
   ‚Üì TESTAR
ETAPA 4: Frontend /capture (14 campos)
   ‚Üì TESTAR
ETAPA 5: Schema Valida√ß√£o
   ‚Üì TESTAR
ETAPA 6: Salvar Banco (APIs + Repos)
   ‚Üì TESTAR TUDO
ETAPA 7: /meus-alimentos + Testes
   ‚Üì
‚úÖ CONCLU√çDO
```

**NUNCA pular etapas!**
**SEMPRE testar ap√≥s cada modifica√ß√£o!**

---

## üìä Estimativa de Tempo

- ETAPA 1: ~5 min (migra√ß√£o + teste)
- ETAPA 2: ~2 min (types)
- ETAPA 3: ~10 min (prompts IA)
- ETAPA 4: ~15 min (frontend capture - 7 campos)
- ETAPA 5: ~2 min (schema)
- ETAPA 6: ~20 min (repos + APIs)
- ETAPA 7: ~25 min (meus-alimentos + testes completos)

**TOTAL: ~80 minutos** (1h20min com testes cuidadosos)

---

## ‚úÖ Crit√©rios de Conclus√£o

Projeto estar√° conclu√≠do quando:

1. ‚úÖ 7 campos existem em `nutrition_data`
2. ‚úÖ 6 campos novos em `food_bank`
3. ‚úÖ IA retorna os 7 campos
4. ‚úÖ Frontend permite editar 14 campos (7+7)
5. ‚úÖ API valida e salva tudo
6. ‚úÖ Refei√ß√µes COM nutrientes funcionam
7. ‚úÖ Refei√ß√µes SEM nutrientes funcionam
8. ‚úÖ Refei√ß√µes ANTIGAS funcionam
9. ‚úÖ Banco de alimentos completo
10. ‚úÖ Todos os testes passam
11. ‚úÖ Documenta√ß√£o atualizada
12. ‚úÖ Zero erros no console

---

## üìû Em Caso de Problemas

Se algo der errado:

1. **PARE imediatamente**
2. **N√ÉO prossiga** para pr√≥xima etapa
3. **Reverta** a mudan√ßa
4. **Teste** que voltou ao normal
5. **Analise** o que deu errado
6. **Corrija** e tente novamente

**Lembre-se**: √â melhor demorar mais e fazer certo! üõ°Ô∏è

---

**Documento criado por**: Claude Code
**√öltima atualiza√ß√£o**: 18/10/2025, 14:10
**Status**: üìã Aguardando aprova√ß√£o para execu√ß√£o
**Vers√£o**: 2.0 (expandido para 7 nutrientes Tier 1)
