# üéØ PLANO: Adicionar Campo `saturated_fat` nas Refei√ß√µes

**Data de Cria√ß√£o**: 18/10/2025, 13:55
**Status**: üìã Planejamento
**Objetivo**: Adicionar rastreamento de gordura saturada nas refei√ß√µes de forma segura e incremental

---

## üìä Contexto

### Situa√ß√£o Atual
- ‚úÖ `saturated_fat` existe na tabela `food_bank` (banco de alimentos)
- ‚ùå `saturated_fat` N√ÉO existe na tabela `nutrition_data` (refei√ß√µes)
- ‚úÖ J√° rastreamos 7 nutrientes: calories, protein_g, carbs_g, fat_g, fiber_g, sodium_mg, sugar_g
- ‚úÖ Gordura saturada √© importante para sa√∫de cardiovascular

### Por que adicionar?
1. Nutriente importante para sa√∫de
2. Consist√™ncia: j√° existe no banco de alimentos
3. Dados j√° dispon√≠veis via IA (pode extrair de fotos)
4. Completar perfil nutricional completo

---

## üéØ Objetivo

Adicionar campo `saturated_fat` em:
- ‚úÖ Tabela `nutrition_data` (banco de dados)
- ‚úÖ Interface de captura `/capture`
- ‚úÖ An√°lise de IA
- ‚úÖ Reposit√≥rios e APIs

**SEM QUEBRAR NADA DO QUE J√Å FUNCIONA**

---

## üîç An√°lise de Impacto

### Arquivos que PRECISAM ser modificados:

1. **Banco de Dados** (1 arquivo)
   - `migrations/014_add_saturated_fat_to_nutrition.sql` (NOVO)

2. **Types/Schemas** (3 arquivos)
   - `lib/ai.ts` - tipo `AiFood`
   - `lib/schemas/meal.ts` - schema de valida√ß√£o
   - `lib/repos/meal.repo.ts` - tipo `DbFoodItem` e queries

3. **APIs** (2 arquivos)
   - `app/api/meals/analyze-meal/route.ts` - passar para IA
   - `app/api/meals/approve/route.ts` - salvar no banco

4. **Frontend** (1 arquivo)
   - `app/capture/page.tsx` - adicionar campo edit√°vel

### Arquivos que N√ÉO precisam mudar:
- ‚ùå `food_bank` (j√° tem o campo)
- ‚ùå `meus-alimentos` (j√° funciona)
- ‚ùå Dashboard/relat√≥rios (podem vir depois)

---

## üìã PLANO DE EXECU√á√ÉO (7 ETAPAS)

### üî∑ ETAPA 1: Criar e Aplicar Migra√ß√£o no Banco
**Objetivo**: Adicionar coluna `saturated_fat` na tabela `nutrition_data`

#### Passos:
1. Criar arquivo `migrations/014_add_saturated_fat_to_nutrition.sql`
2. Migra√ß√£o deve ser ADITIVA (n√£o remove nada)
3. Coluna deve ser NULLABLE (n√£o quebra dados existentes)
4. Testar localmente primeiro

#### C√≥digo da Migra√ß√£o:
```sql
-- Migration: Add saturated_fat to nutrition_data
-- Date: 18/10/2025
-- SAFE: Aditiva, n√£o quebra dados existentes

ALTER TABLE nutrition_data
ADD COLUMN saturated_fat NUMERIC(10,2) NULL;

COMMENT ON COLUMN nutrition_data.saturated_fat IS 'Gordura saturada em gramas';
```

#### Teste desta etapa:
```bash
# 1. Executar migra√ß√£o
npx tsx scripts/apply-migrations.ts

# 2. Verificar que coluna foi criada
npx tsx scripts/extract-schema.ts

# 3. Verificar em docs/database/CURRENT_SCHEMA.md que saturated_fat aparece

# 4. TESTAR APP: Tudo deve continuar funcionando normalmente!
# - Capturar foto de refei√ß√£o
# - Aprovar refei√ß√£o
# - Ver no dashboard
```

#### Crit√©rio de Sucesso:
- ‚úÖ Migra√ß√£o aplicada sem erros
- ‚úÖ Coluna existe no schema
- ‚úÖ App continua funcionando (refei√ß√µes antigas sem o campo)
- ‚úÖ Nenhum erro no console

#### Rollback se der errado:
```sql
ALTER TABLE nutrition_data DROP COLUMN saturated_fat;
```

---

### üî∑ ETAPA 2: Atualizar Type `AiFood` (lib/ai.ts)
**Objetivo**: IA saber que pode retornar `saturated_fat`

#### Modifica√ß√£o:
```typescript
// ANTES:
export type AiFood = {
  name: string;
  quantity: number;
  unit: string;
  calories?: number;
  protein_g?: number;
  carbs_g?: number;
  fat_g?: number;
  fiber_g?: number;
  sodium_mg?: number;
  sugar_g?: number;
};

// DEPOIS:
export type AiFood = {
  name: string;
  quantity: number;
  unit: string;
  calories?: number;
  protein_g?: number;
  carbs_g?: number;
  fat_g?: number;
  fiber_g?: number;
  sodium_mg?: number;
  sugar_g?: number;
  saturated_fat_g?: number;  // üÜï NOVO CAMPO
};
```

#### Teste desta etapa:
```bash
# 1. Compilar TypeScript
npm run build

# 2. Verificar que n√£o h√° erros de tipo
# 3. App deve continuar funcionando
```

#### Crit√©rio de Sucesso:
- ‚úÖ TypeScript compila sem erros
- ‚úÖ App continua funcionando
- ‚úÖ Nenhum erro no console

---

### üî∑ ETAPA 3: Atualizar Prompt da IA (api/meals/analyze-meal)
**Objetivo**: IA come√ßar a retornar gordura saturada

#### Modifica√ß√£o em `/app/api/meals/analyze-meal/route.ts`:

**Linha ~50** (onde monta descri√ß√£o do alimento do banco):
```typescript
// ADICIONAR saturated_fat na descri√ß√£o:
if (f.saturated_fat !== undefined && f.saturated_fat !== null) {
  parts.push(`${f.saturated_fat}g gordura saturada`);
}
```

**Linha ~65** (prompt para a IA):
```typescript
// ADICIONAR no exemplo JSON:
{
  "name": "Arroz",
  "quantity": 2,
  "unit": "colheres",
  "calories": 130,
  "protein_g": 2.7,
  "carbs_g": 28,
  "fat_g": 0.3,
  "fiber_g": 0.4,
  "sodium_mg": 1,
  "sugar_g": 0.1,
  "saturated_fat_g": 0.1  // üÜï ADICIONAR
}
```

#### Teste desta etapa:
```bash
# 1. Testar an√°lise de refei√ß√£o
# 2. Verificar no console do navegador o JSON retornado pela IA
# 3. Verificar se saturated_fat_g aparece (pode ser null/undefined por enquanto)
# 4. App deve continuar funcionando
```

#### Crit√©rio de Sucesso:
- ‚úÖ IA retorna o novo campo (mesmo que 0 ou null)
- ‚úÖ An√°lise continua funcionando
- ‚úÖ Nenhum erro no console

---

### üî∑ ETAPA 4: Adicionar Campo no Frontend (/capture)
**Objetivo**: Usu√°rio poder visualizar e editar gordura saturada

#### Modifica√ß√£o em `/app/capture/page.tsx`:

**Adicionar campo edit√°vel** (depois de `sugar_g`, linha ~784):
```tsx
<div>
  <label style={{ fontSize: 12, color: '#666', display: 'block', marginBottom: 4 }}>
    üî¥ Gord. Sat. (g)
  </label>
  <input
    type="number"
    step="0.1"
    value={food.saturated_fat_g || ''}
    onChange={e => {
      const updated = [...analysis.foods];
      updated[i].saturated_fat_g = Number(e.target.value) || undefined;
      setAnalysis({ ...analysis, foods: updated });
    }}
    style={{
      width: '100%',
      padding: '6px 8px',
      fontSize: 14,
      border: '1px solid #d1d5db',
      borderRadius: 6,
      outline: 'none',
      boxSizing: 'border-box'
    }}
    placeholder="0"
  />
</div>
```

#### Teste desta etapa:
```bash
# 1. Capturar foto de refei√ß√£o
# 2. Verificar que campo "Gord. Sat." aparece
# 3. Editar o valor manualmente
# 4. Verificar que valor √© mantido
# 5. N√ÉO APROVAR ainda (pr√≥xima etapa)
```

#### Crit√©rio de Sucesso:
- ‚úÖ Campo aparece na tela
- ‚úÖ Pode editar o valor
- ‚úÖ Valor √© mantido no estado
- ‚úÖ CSS responsivo (n√£o vaza do box em mobile)

---

### üî∑ ETAPA 5: Atualizar Schema de Valida√ß√£o (lib/schemas/meal.ts)
**Objetivo**: Validar que `saturated_fat_g` √© aceito na API

#### Modifica√ß√£o em `/lib/schemas/meal.ts`:

Encontrar o schema do food e adicionar:
```typescript
const FoodItemSchema = z.object({
  name: z.string(),
  quantity: z.number(),
  unit: z.string(),
  calories: z.number().optional(),
  protein_g: z.number().optional(),
  carbs_g: z.number().optional(),
  fat_g: z.number().optional(),
  fiber_g: z.number().optional(),
  sodium_mg: z.number().optional(),
  sugar_g: z.number().optional(),
  saturated_fat_g: z.number().optional()  // üÜï ADICIONAR
});
```

#### Teste desta etapa:
```bash
# 1. Verificar que TypeScript compila
# 2. Tentar aprovar refei√ß√£o (pode falhar ainda, normal)
# 3. Verificar mensagem de erro (deve ser clara)
```

#### Crit√©rio de Sucesso:
- ‚úÖ TypeScript compila
- ‚úÖ Schema aceita o novo campo
- ‚úÖ Valida√ß√£o funciona

---

### üî∑ ETAPA 6: Salvar no Banco (api/meals/approve + meal.repo)
**Objetivo**: Persistir `saturated_fat` no banco de dados

#### 6.1 - Modifica√ß√£o em `/app/api/meals/approve/route.ts` (linha ~79):
```typescript
foods: data.foods.map((f: any) => ({
  name: f.name,
  quantity: f.quantity,
  unit: f.unit,
  calories: f.calories ?? undefined,
  protein_g: f.protein_g ?? undefined,
  carbs_g: f.carbs_g ?? undefined,
  fat_g: f.fat_g ?? undefined,
  fiber_g: f.fiber_g ?? undefined,
  sodium_mg: f.sodium_mg ?? undefined,
  sugar_g: f.sugar_g ?? undefined,
  saturated_fat_g: f.saturated_fat_g ?? undefined  // üÜï ADICIONAR
}))
```

#### 6.2 - Modifica√ß√£o em `/lib/repos/meal.repo.ts`:

**Tipo (linha ~38)**:
```typescript
foods: Array<{
  name: string;
  quantity: number;
  unit: string;
  calories?: number;
  confidence?: number;
  protein_g?: number;
  carbs_g?: number;
  fat_g?: number;
  fiber_g?: number;
  sodium_mg?: number;
  sugar_g?: number;
  saturated_fat_g?: number;  // üÜï ADICIONAR
}>;
```

**Condi√ß√£o hasAny (linha ~88)**:
```typescript
const hasAny = (
  typeof f.calories === 'number' ||
  typeof (f as any).protein_g === 'number' ||
  typeof (f as any).carbs_g === 'number' ||
  typeof (f as any).fat_g === 'number' ||
  typeof (f as any).fiber_g === 'number' ||
  typeof (f as any).sodium_mg === 'number' ||
  typeof (f as any).sugar_g === 'number' ||
  typeof (f as any).saturated_fat_g === 'number'  // üÜï ADICIONAR
);
```

**Query INSERT (linha ~94)**:
```sql
INSERT INTO nutrition_data (
  food_item_id, tenant_id, calories, protein_g, carbs_g,
  fat_g, fiber_g, sodium_mg, sugar_g, saturated_fat_g
)
VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10)
ON CONFLICT (food_item_id)
DO UPDATE SET
  calories = COALESCE(EXCLUDED.calories, nutrition_data.calories),
  protein_g = COALESCE(EXCLUDED.protein_g, nutrition_data.protein_g),
  carbs_g = COALESCE(EXCLUDED.carbs_g, nutrition_data.carbs_g),
  fat_g = COALESCE(EXCLUDED.fat_g, nutrition_data.fat_g),
  fiber_g = COALESCE(EXCLUDED.fiber_g, nutrition_data.fiber_g),
  sodium_mg = COALESCE(EXCLUDED.sodium_mg, nutrition_data.sodium_mg),
  sugar_g = COALESCE(EXCLUDED.sugar_g, nutrition_data.sugar_g),
  saturated_fat_g = COALESCE(EXCLUDED.saturated_fat_g, nutrition_data.saturated_fat_g)
```

**Par√¢metros (linha ~104)**:
```typescript
[
  foodItem.id,
  args.tenantId,
  f.calories ?? 0,
  (f as any).protein_g ?? 0,
  (f as any).carbs_g ?? 0,
  (f as any).fat_g ?? 0,
  (f as any).fiber_g ?? 0,
  (f as any).sodium_mg ?? null,
  (f as any).sugar_g ?? null,
  (f as any).saturated_fat_g ?? null  // üÜï ADICIONAR
]
```

**Repetir o mesmo para `insertMealWithItemsTx`** (segunda fun√ß√£o no mesmo arquivo)

#### Teste desta etapa:
```bash
# TESTE COMPLETO END-TO-END:

# 1. Capturar foto de refei√ß√£o
# 2. Verificar que IA retorna saturated_fat_g
# 3. Editar valor se necess√°rio
# 4. Aprovar refei√ß√£o
# 5. Verificar que salvou sem erros
# 6. Verificar no banco (Supabase dashboard) que o valor est√° l√°
# 7. Capturar outra refei√ß√£o SEM saturated_fat (deixar vazio)
# 8. Aprovar e verificar que funciona (null/0)
```

#### Crit√©rio de Sucesso:
- ‚úÖ Refei√ß√£o salva COM saturated_fat
- ‚úÖ Refei√ß√£o salva SEM saturated_fat (campos vazios)
- ‚úÖ Dados aparecem corretamente no banco
- ‚úÖ Nenhum erro no console
- ‚úÖ Refei√ß√µes antigas continuam funcionando

---

### üî∑ ETAPA 7: Testes Finais e Documenta√ß√£o
**Objetivo**: Garantir que tudo funciona e documentar

#### Testes de Regress√£o:
1. ‚úÖ Cadastrar alimento manual em "Meus Alimentos" (COM saturated_fat)
2. ‚úÖ Cadastrar alimento via IA em "Meus Alimentos" (foto de r√≥tulo)
3. ‚úÖ Editar alimento existente e adicionar saturated_fat
4. ‚úÖ Capturar refei√ß√£o do banco de alimentos
5. ‚úÖ Capturar refei√ß√£o nova (foto)
6. ‚úÖ Capturar refei√ß√£o manual (adicionar alimento novo)
7. ‚úÖ Aprovar refei√ß√£o com todos os campos preenchidos
8. ‚úÖ Aprovar refei√ß√£o com saturated_fat vazio
9. ‚úÖ Verificar refei√ß√µes antigas (devem continuar vis√≠veis)
10. ‚úÖ Verificar dashboard (n√£o deve quebrar)

#### Documenta√ß√£o:
1. Atualizar `docs/database/CURRENT_SCHEMA.md` (rodar script)
2. Marcar este plano como ‚úÖ CONCLU√çDO
3. Adicionar coment√°rio sobre saturated_fat em c√≥digo relevante

---

## üö® Pontos de Aten√ß√£o (CUIDADO!)

### ‚ö†Ô∏è Riscos e Como Mitigar:

1. **Migra√ß√£o falhar**
   - ‚úÖ Migra√ß√£o √© ADITIVA (n√£o remove nada)
   - ‚úÖ Coluna √© NULLABLE (n√£o quebra dados existentes)
   - ‚úÖ Testar em ambiente local primeiro
   - ‚úÖ Ter rollback pronto

2. **TypeScript n√£o compilar**
   - ‚úÖ Adicionar campo como OPTIONAL (`?`)
   - ‚úÖ Testar build antes de commit

3. **Query SQL com n√∫mero errado de par√¢metros**
   - ‚úÖ Contar os `$1, $2, ...` e os valores no array
   - ‚úÖ Testar inser√ß√£o no banco

4. **Refei√ß√µes antigas quebrarem**
   - ‚úÖ Campo √© NULLABLE no banco
   - ‚úÖ Campo √© OPTIONAL no TypeScript
   - ‚úÖ Usar `?? null` ou `?? undefined` em queries

5. **IA n√£o retornar o campo**
   - ‚úÖ Campo √© OPTIONAL
   - ‚úÖ Sistema aceita null/undefined
   - ‚úÖ Usu√°rio pode editar manualmente

---

## üìù Checklist de Seguran√ßa

Antes de cada commit, verificar:

- [ ] TypeScript compila sem erros (`npm run build`)
- [ ] Next.js inicia sem erros (`npm run dev`)
- [ ] Nenhum erro no console do navegador
- [ ] Testar fluxo completo (foto ‚Üí an√°lise ‚Üí aprova√ß√£o)
- [ ] Testar com campos vazios
- [ ] Testar com campos preenchidos
- [ ] Verificar banco de dados (dados corretos)
- [ ] Refei√ß√µes antigas continuam funcionando

---

## üéØ Ordem de Execu√ß√£o

### Sequ√™ncia OBRIGAT√ìRIA:

```
1. ETAPA 1 (Migra√ß√£o)
   ‚Üì TESTAR
   ‚Üì
2. ETAPA 2 (Type)
   ‚Üì TESTAR
   ‚Üì
3. ETAPA 3 (Prompt IA)
   ‚Üì TESTAR
   ‚Üì
4. ETAPA 4 (Frontend)
   ‚Üì TESTAR
   ‚Üì
5. ETAPA 5 (Schema Valida√ß√£o)
   ‚Üì TESTAR
   ‚Üì
6. ETAPA 6 (Salvar Banco)
   ‚Üì TESTAR TUDO
   ‚Üì
7. ETAPA 7 (Testes Finais)
   ‚Üì
‚úÖ CONCLU√çDO
```

**NUNCA pular etapas!**
**SEMPRE testar ap√≥s cada modifica√ß√£o!**

---

## üìä Estimativa de Tempo

- ETAPA 1: ~5 min (migra√ß√£o + teste)
- ETAPA 2: ~2 min (type)
- ETAPA 3: ~5 min (prompt IA)
- ETAPA 4: ~5 min (frontend)
- ETAPA 5: ~2 min (schema)
- ETAPA 6: ~10 min (repo + API)
- ETAPA 7: ~15 min (testes completos)

**TOTAL: ~45 minutos** (com testes cuidadosos)

---

## ‚úÖ Crit√©rios de Conclus√£o

Projeto estar√° conclu√≠do quando:

1. ‚úÖ Campo `saturated_fat` existe no banco
2. ‚úÖ IA retorna o campo (quando poss√≠vel)
3. ‚úÖ Frontend permite editar o campo
4. ‚úÖ API valida e salva o campo
5. ‚úÖ Refei√ß√µes COM saturated_fat funcionam
6. ‚úÖ Refei√ß√µes SEM saturated_fat funcionam
7. ‚úÖ Refei√ß√µes ANTIGAS continuam funcionando
8. ‚úÖ Todos os testes passam
9. ‚úÖ Documenta√ß√£o atualizada
10. ‚úÖ Zero erros no console

---

## üìû Em Caso de Problemas

Se algo der errado em qualquer etapa:

1. **PARE imediatamente**
2. **N√ÉO prossiga** para pr√≥xima etapa
3. **Reverta** a mudan√ßa que causou o problema
4. **Teste** que o sistema voltou ao normal
5. **Analise** o que deu errado
6. **Corrija** e tente novamente

**Lembre-se**: √â melhor demorar mais e fazer certo do que quebrar o que funciona! üõ°Ô∏è

---

**Documento criado por**: Claude Code
**√öltima atualiza√ß√£o**: 18/10/2025, 13:55
**Status**: üìã Aguardando aprova√ß√£o para execu√ß√£o
