# üìã PLANO DE IMPLEMENTA√á√ÉO - NOVAS FUNCIONALIDADES

**Data**: 16/10/2025
**Projeto**: Food Tracker
**Status**: ‚úÖ Em Andamento - 3 de 6 features conclu√≠das

---

## üéØ OBJETIVOS

Adicionar 7 novas funcionalidades ao food-tracker sem quebrar o que j√° est√° funcionando:

1. Campo de texto para fotos de refei√ß√£o
2. Local da refei√ß√£o (casa/rua) com autocomplete de restaurantes
3. Banco de Alimentos com an√°lise de IA de tabelas nutricionais
4. Edi√ß√£o de valores nutricionais gerados pela IA
5. Registro de peso di√°rio
6. An√°lise de IA nos relat√≥rios com per√≠odo customiz√°vel
7. Manter tudo funcionando perfeitamente

---

## üìä PROGRESSO ATUAL

### ‚úÖ FEATURES CONCLU√çDAS (3/6)

**‚úÖ Feature #1: Campo de texto para fotos de refei√ß√£o**
- Arquivo modificado: `app/capture/page.tsx`
- Adicionado campo `photoDescription` que combina com `notes`
- Texto salvo no campo existente `meals.notes`
- Exibido na revis√£o e hist√≥rico

**‚úÖ Feature #4: Edi√ß√£o de valores nutricionais**
- Arquivo modificado: `app/capture/page.tsx`
- Todos os campos nutricionais (calorias, prote√≠nas, carboidratos, gorduras) s√£o edit√°veis
- Inputs num√©ricos com atualiza√ß√£o em tempo real
- Valores editados s√£o salvos corretamente

**‚úÖ Feature #5: Registro de peso di√°rio**
- Migra√ß√£o #4 executada: tabela `weight_logs` criada com UUID
- Arquivos criados:
  - `lib/repos/weight.repo.ts` (CRUD completo)
  - `app/api/weight/route.ts` (REST API)
  - `app/peso/page.tsx` (UI completa)
- Menu "Peso ‚öñÔ∏è" adicionado em `components/AppLayout.tsx`
- Funcionalidades: registro, hist√≥rico, exclus√£o, exibi√ß√£o do √∫ltimo peso

### ‚è≥ FEATURES PENDENTES (3/6)

**Feature #2: Local da refei√ß√£o + Restaurantes**
- Requer migra√ß√µes #1 e #2 (n√£o executadas ainda)
- Arquivos de migra√ß√£o criados em `docs/migrations/`

**Feature #6: An√°lise de IA nos relat√≥rios**
- N√£o requer migra√ß√£o
- Pr√≥xima recomendada para implementa√ß√£o

**Feature #3: Banco de Alimentos**
- Requer migra√ß√£o #3 (n√£o executada ainda)
- Arquivo de migra√ß√£o criado em `docs/migrations/`

### üõ†Ô∏è INFRAESTRUTURA ADICIONAL CRIADA

**Sistema de Documenta√ß√£o Autom√°tica do Schema**
- Script: `scripts/extract-schema.ts`
- Comando: `npm run db:schema`
- Gera: `docs/database/CURRENT_SCHEMA.md`
- Documenta√ß√£o: `docs/database/README.md`
- **Prop√≥sito**: Evitar erros de tipo (INTEGER vs UUID) em futuras migra√ß√µes

**Arquivos de Migra√ß√£o Corrigidos**
- Todos os arquivos em `docs/migrations/` foram corrigidos para usar UUID
- Migra√ß√µes usam `uuid_generate_v4()` ao inv√©s de SERIAL/INTEGER

---

## üèóÔ∏è ARQUITETURA ATUAL

**Stack Identificado**:
- Next.js 14 + React 18 + TypeScript
- PostgreSQL (Supabase)
- Google Gemini AI
- NextAuth para autentica√ß√£o
- Multi-tenant com isolamento por tenant_id

**Banco de Dados Atual** (8 tabelas):
- `tenants`
- `users`
- `meals`
- `food_items`
- `nutrition_data`
- `water_intake`
- `bowel_movements`
- `weight_logs` ‚úÖ (adicionada)

---

## ‚ö†Ô∏è REGRAS IMPORTANTES

### üî¥ MIGRA√á√ïES DE BANCO DE DADOS
- **TODAS as migra√ß√µes SQL devem ser executadas MANUALMENTE no dashboard do Supabase**
- **NUNCA executar migra√ß√µes automaticamente pelo c√≥digo**
- O desenvolvedor ser√° informado quando cada migra√ß√£o deve ser executada
- Aguardar confirma√ß√£o antes de prosseguir com o c√≥digo que depende da migra√ß√£o

### üõ°Ô∏è PROTE√á√ÉO DO C√ìDIGO EXISTENTE
- Testar cada feature isoladamente antes de integrar
- Manter multi-tenancy em todas as novas queries
- Preservar TypeScript + Zod em todas as valida√ß√µes
- N√£o modificar estruturas existentes sem necessidade

---

## üìù DETALHAMENTO DAS FEATURES

### **1Ô∏è‚É£ Campo de texto para fotos de refei√ß√£o**

**Impacto**: BAIXO - Apenas UI/UX
**Status**: ‚úÖ CONCLU√çDA

**Arquivos afetados**:
- `app/capture/page.tsx` - Adicionar textarea
- Banco de dados - Campo `notes` j√° existe na tabela `meals`

**Passos**:
1. ‚úÖ Adicionar campo de texto (textarea) na UI de captura de foto
2. ‚úÖ Salvar o texto junto com a foto no campo `notes` existente
3. ‚úÖ Exibir o texto na revis√£o da refei√ß√£o
4. ‚úÖ Mostrar o texto no hist√≥rico

**Depend√™ncias**: Nenhuma
**Migra√ß√£o necess√°ria**: ‚ùå N√£o

---

### **2Ô∏è‚É£ Local da refei√ß√£o (casa/rua) + Restaurantes**

**Impacto**: M√âDIO - Nova tabela + Autocomplete
**Status**: ‚è≥ Pendente

**Novos arquivos**:
- `lib/db/restaurants.ts` - CRUD de restaurantes
- `app/api/restaurants/route.ts` - API de autocomplete
- `app/api/restaurants/search/route.ts` - Busca por nome
- Componente de sele√ß√£o de local

**Passos**:
1. üî¥ **EXECUTAR MIGRA√á√ÉO #1** (criar tabela `restaurants`)
2. üî¥ **EXECUTAR MIGRA√á√ÉO #2** (adicionar campos em `meals`)
3. ‚úÖ Criar CRUD de restaurantes
4. ‚úÖ Criar API de autocomplete
5. ‚úÖ Criar componente de sele√ß√£o de local
6. ‚úÖ Integrar no formul√°rio de captura
7. ‚úÖ Exibir local no hist√≥rico e relat√≥rios

**Depend√™ncias**: Migra√ß√µes #1 e #2
**Migra√ß√£o necess√°ria**: ‚úÖ Sim (ver se√ß√£o Migra√ß√µes)

---

### **3Ô∏è‚É£ Banco de Alimentos ("Meus Alimentos")**

**Impacto**: ALTO - Novo m√≥dulo completo
**Status**: ‚è≥ Pendente

**Sugest√µes de nome**:
- ü•á **"Meus Alimentos"** (escolhido)
- "Alimentos Favoritos"
- "Biblioteca de Alimentos"
- "Banco de Alimentos"

**Novos arquivos**:
- `app/meus-alimentos/page.tsx` - P√°gina principal (listagem)
- `app/meus-alimentos/novo/page.tsx` - Cadastro de novo alimento
- `app/api/food-bank/route.ts` - CRUD
- `app/api/food-bank/analyze-label/route.ts` - IA para analisar tabela nutricional
- `lib/db/food-bank.ts` - L√≥gica de banco de dados
- `lib/ai/nutrition-label-analyzer.ts` - An√°lise de tabela nutricional

**Passos**:
1. üî¥ **EXECUTAR MIGRA√á√ÉO #3** (criar tabela `food_bank`)
2. ‚úÖ Criar p√°gina de listagem de alimentos
3. ‚úÖ Criar formul√°rio de cadastro com upload de foto
4. ‚úÖ Integrar Gemini AI para extrair dados da tabela nutricional
5. ‚úÖ Permitir cadastro manual sem foto
6. ‚úÖ Adicionar menu na navega√ß√£o
7. ‚úÖ Criar sistema de cache/favoritos baseado em uso
8. ‚úÖ Permitir usar alimento do banco na captura de refei√ß√£o

**Depend√™ncias**: Migra√ß√£o #3
**Migra√ß√£o necess√°ria**: ‚úÖ Sim (ver se√ß√£o Migra√ß√µes)

---

### **4Ô∏è‚É£ Edi√ß√£o de valores nutricionais**

**Impacto**: BAIXO - Apenas UI interativa
**Status**: ‚úÖ CONCLU√çDA

**Arquivos afetados**:
- `app/capture/page.tsx` - Tornar campos edit√°veis
- `app/api/meals/route.ts` - J√° suporta edi√ß√£o (apenas usar)

**Passos**:
1. ‚úÖ Transformar exibi√ß√£o de nutrientes em campos edit√°veis
2. ‚úÖ Adicionar valida√ß√£o de valores num√©ricos (Zod)
3. ‚úÖ Permitir salvar valores editados
4. ‚úÖ Adicionar feedback visual de edi√ß√£o
5. ‚ö™ (Opcional) Manter hist√≥rico de edi√ß√µes

**Depend√™ncias**: Nenhuma
**Migra√ß√£o necess√°ria**: ‚ùå N√£o

---

### **5Ô∏è‚É£ Registro de peso di√°rio**

**Impacto**: M√âDIO - Nova tabela + Nova p√°gina
**Status**: ‚úÖ CONCLU√çDA

**Arquivos criados**:
- `app/peso/page.tsx` - P√°gina de registro ‚úÖ
- `app/api/weight/route.ts` - CRUD ‚úÖ
- `lib/repos/weight.repo.ts` - L√≥gica de banco de dados ‚úÖ
- `components/AppLayout.tsx` - Menu "Peso ‚öñÔ∏è" adicionado ‚úÖ

**Passos**:
1. ‚úÖ **MIGRA√á√ÉO #4 EXECUTADA** (tabela `weight_logs` criada com UUID)
2. ‚úÖ Criar p√°gina de registro de peso
3. ‚úÖ Criar formul√°rio de entrada de peso
4. ‚è∏Ô∏è Adicionar gr√°fico de evolu√ß√£o de peso (planejado para futuro)
5. ‚è∏Ô∏è Integrar dados de peso nos relat√≥rios (planejado para futuro)
6. ‚úÖ Adicionar menu na navega√ß√£o
7. ‚úÖ Permitir m√∫ltiplos registros por dia (pegar o mais recente)
8. ‚úÖ Implementar funcionalidade de exclus√£o de registros

**Depend√™ncias**: Migra√ß√£o #4 ‚úÖ EXECUTADA
**Migra√ß√£o necess√°ria**: ‚úÖ Sim - J√Å EXECUTADA

---

### **6Ô∏è‚É£ An√°lise de IA nos relat√≥rios + Per√≠odo customiz√°vel**

**Impacto**: M√âDIO - Extens√£o de funcionalidade existente
**Status**: ‚è≥ Pendente

**Arquivos afetados**:
- `app/reports/page.tsx` - Adicionar filtros de data
- `app/api/reports/analysis/route.ts` - Nova API
- `lib/ai/reports-analysis.ts` - L√≥gica de an√°lise

**Passos**:
1. ‚úÖ Adicionar seletor de per√≠odo customiz√°vel (date range picker)
2. ‚úÖ Adicionar op√ß√£o de per√≠odo: di√°rio, semanal, ou customizado
3. ‚úÖ Criar prompt para IA analisar refei√ß√µes do per√≠odo
4. ‚úÖ Criar API que envia dados para Gemini e retorna an√°lise
5. ‚úÖ Exibir an√°lise em formato leg√≠vel na p√°gina de relat√≥rios
6. ‚úÖ Incluir an√°lises sobre:
   - Balan√ßo cal√≥rico
   - Distribui√ß√£o de macronutrientes
   - Alimentos inflamat√≥rios consumidos
   - Regularidade das refei√ß√µes
   - Hidrata√ß√£o
   - Sugest√µes de melhoria

**Depend√™ncias**: Nenhuma
**Migra√ß√£o necess√°ria**: ‚ùå N√£o

---

## üóÑÔ∏è MIGRA√á√ïES DE BANCO DE DADOS

### üìå IMPORTANTE
**Todas as migra√ß√µes devem ser executadas MANUALMENTE no dashboard do Supabase.**
Voc√™ ser√° avisado quando executar cada uma delas.

---

### üî¥ MIGRA√á√ÉO #1: Criar tabela `restaurants`

**Quando executar**: Antes de implementar Feature #2

```sql
-- Tabela de restaurantes
CREATE TABLE restaurants (
  id SERIAL PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  address TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- √çndice para busca r√°pida por tenant
CREATE INDEX idx_restaurants_tenant_id ON restaurants(tenant_id);

-- √çndice para autocomplete por nome
CREATE INDEX idx_restaurants_name ON restaurants(name);

COMMENT ON TABLE restaurants IS 'Cadastro de restaurantes para rastreamento de refei√ß√µes externas';
```

---

### üî¥ MIGRA√á√ÉO #2: Adicionar campos de localiza√ß√£o em `meals`

**Quando executar**: Ap√≥s MIGRA√á√ÉO #1, antes de implementar Feature #2

```sql
-- Adicionar campos de localiza√ß√£o na tabela meals
ALTER TABLE meals
  ADD COLUMN location_type VARCHAR(10) CHECK (location_type IN ('home', 'out')),
  ADD COLUMN restaurant_id INTEGER REFERENCES restaurants(id) ON DELETE SET NULL;

-- √çndice para filtrar por tipo de local
CREATE INDEX idx_meals_location_type ON meals(location_type);

-- √çndice para buscar refei√ß√µes por restaurante
CREATE INDEX idx_meals_restaurant_id ON meals(restaurant_id);

COMMENT ON COLUMN meals.location_type IS 'Tipo de local: home (casa) ou out (fora de casa)';
COMMENT ON COLUMN meals.restaurant_id IS 'Refer√™ncia ao restaurante se location_type = out';
```

---

### üî¥ MIGRA√á√ÉO #3: Criar tabela `food_bank`

**Quando executar**: Antes de implementar Feature #3

```sql
-- Tabela de banco de alimentos
CREATE TABLE food_bank (
  id SERIAL PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  brand VARCHAR(255),
  serving_size VARCHAR(100),
  photo_url TEXT,

  -- Informa√ß√µes nutricionais (por por√ß√£o)
  calories DECIMAL(10,2),
  protein DECIMAL(10,2),
  carbs DECIMAL(10,2),
  fat DECIMAL(10,2),
  fiber DECIMAL(10,2),
  sodium DECIMAL(10,2),
  sugar DECIMAL(10,2),
  saturated_fat DECIMAL(10,2),

  -- Controle de uso
  usage_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMP,

  -- Metadados
  source VARCHAR(50) DEFAULT 'manual', -- 'manual' ou 'ai_analyzed'
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- √çndices
CREATE INDEX idx_food_bank_tenant_id ON food_bank(tenant_id);
CREATE INDEX idx_food_bank_user_id ON food_bank(user_id);
CREATE INDEX idx_food_bank_name ON food_bank(name);
CREATE INDEX idx_food_bank_usage_count ON food_bank(usage_count DESC);

COMMENT ON TABLE food_bank IS 'Banco de alimentos frequentes com informa√ß√µes nutricionais';
COMMENT ON COLUMN food_bank.source IS 'Origem dos dados: manual ou ai_analyzed (tabela nutricional)';
```

---

### üî¥ MIGRA√á√ÉO #4: Criar tabela `weight_logs`

**Quando executar**: Antes de implementar Feature #5

```sql
-- Tabela de registro de peso
CREATE TABLE weight_logs (
  id SERIAL PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  weight DECIMAL(5,2) NOT NULL CHECK (weight > 0 AND weight < 500),
  log_date DATE NOT NULL,
  log_time TIME DEFAULT CURRENT_TIME,
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- Um usu√°rio pode ter m√∫ltiplos registros por dia (manh√£/noite)
  UNIQUE(user_id, log_date, log_time, tenant_id)
);

-- √çndices
CREATE INDEX idx_weight_logs_tenant_id ON weight_logs(tenant_id);
CREATE INDEX idx_weight_logs_user_id ON weight_logs(user_id);
CREATE INDEX idx_weight_logs_date ON weight_logs(log_date DESC);

COMMENT ON TABLE weight_logs IS 'Registro di√°rio de peso dos usu√°rios';
COMMENT ON COLUMN weight_logs.weight IS 'Peso em kg, limite entre 0 e 500kg';
```

---

## üéØ ORDEM DE IMPLEMENTA√á√ÉO

### **Estrat√©gia**: Do mais simples ao mais complexo

1. **Feature #1** - Campo de texto em fotos (SEM migra√ß√£o)
2. **Feature #4** - Editar nutrientes (SEM migra√ß√£o)
3. **Feature #5** - Peso di√°rio (MIGRA√á√ÉO #4)
4. **Feature #2** - Local/restaurantes (MIGRA√á√ïES #1 e #2)
5. **Feature #6** - An√°lise IA relat√≥rios (SEM migra√ß√£o)
6. **Feature #3** - Banco de Alimentos (MIGRA√á√ÉO #3)

### **Justificativa da ordem**:
- Come√ßar sem migra√ß√µes para validar fluxo
- Testar integra√ß√£o com IA antes de features complexas
- Deixar m√≥dulo mais complexo (Banco de Alimentos) por √∫ltimo

---

## ‚úÖ CHECKLIST DE VALIDA√á√ÉO

Para cada feature implementada, verificar:

### üîí Seguran√ßa
- [ ] Multi-tenancy respeitado (tenant_id em todas as queries)
- [ ] Valida√ß√£o de permiss√µes por usu√°rio
- [ ] Sanitiza√ß√£o de inputs
- [ ] Prote√ß√£o contra SQL injection (usar queries parametrizadas)

### üíª C√≥digo
- [ ] TypeScript sem erros
- [ ] Valida√ß√£o Zod implementada
- [ ] Tratamento de erros adequado
- [ ] C√≥digo comentado em pontos complexos

### üé® Interface
- [ ] UI responsiva (mobile-first)
- [ ] Loading states implementados
- [ ] Mensagens de erro em portugu√™s
- [ ] Feedback visual de sucesso/erro

### üß™ Testes
- [ ] Funcionalidade testada manualmente
- [ ] Features existentes n√£o foram quebradas
- [ ] Testar em diferentes tamanhos de tela
- [ ] Testar com dados reais

---

## üìä CRONOGRAMA ESTIMADO

| Feature | Complexidade | Tempo Estimado |
|---------|--------------|----------------|
| #1 - Texto em fotos | Baixa | 1-2h |
| #4 - Editar nutrientes | Baixa | 2-3h |
| #5 - Peso di√°rio | M√©dia | 4-6h |
| #2 - Local/restaurantes | M√©dia | 5-7h |
| #6 - An√°lise IA relat√≥rios | M√©dia | 6-8h |
| #3 - Banco de Alimentos | Alta | 10-12h |
| **TOTAL** | - | **28-38h** |

*Tempo n√£o inclui testes extensivos e ajustes finos*

---

## üìù NOTAS FINAIS

### ‚ö†Ô∏è Pontos de aten√ß√£o
1. **Sempre** testar multi-tenancy
2. **Sempre** aguardar confirma√ß√£o antes de executar migra√ß√µes
3. **Sempre** validar que features existentes n√£o quebraram
4. Manter consist√™ncia de UI/UX com o resto do app
5. Usar portugu√™s em todas as mensagens para o usu√°rio

### üéØ Objetivo principal
**Adicionar todas as funcionalidades sem quebrar nada que j√° est√° funcionando!**

---

**Status atual**: ‚úÖ 3 de 6 features conclu√≠das
**Pr√≥ximo passo recomendado**: Feature #6 - An√°lise de IA nos relat√≥rios (n√£o requer migra√ß√£o)
**Alternativa**: Feature #2 - Local/restaurantes (requer executar migra√ß√µes #1 e #2 primeiro)

---

## üîß Atualiza√ß√£o de 16/10/2025 ‚Äî Corre√ß√£o na An√°lise de Per√≠odo (IA)

**Contexto**
- Ao solicitar a an√°lise de per√≠odo na p√°gina de relat√≥rios, ocorria o erro: `Cannot read properties of undefined (reading 'query')`.

**Causa Raiz**
- No endpoint `app/api/reports/analysis/route.ts`, o c√≥digo importava um s√≠mbolo inexistente (`{ db }` de `@/lib/db`) e chamava `db.query(...)`.
- O m√≥dulo correto exporta `getPool()` (PostgreSQL `Pool`), portanto `db` era `undefined` e o acesso a `.query` quebrava.

**Corre√ß√£o Aplicada**
- Substitu√≠da a importa√ß√£o por `import { getPool } from '@/lib/db';` e criada uma inst√¢ncia `const pool = getPool();`.
- Trocado `db.query(...)` por `pool.query(...)` para buscar o hist√≥rico de √°gua no per√≠odo.
- Arquivo ajustado: `app/api/reports/analysis/route.ts` (se√ß√£o de busca de hidrata√ß√£o).

**Observa√ß√µes**
- O arquivo de an√°lise de IA est√° em `lib/ai/reports-analyzer.ts` (nome real). O plano menciona `lib/ai/reports-analysis.ts` ‚Äî manteremos essa refer√™ncia, mas tomamos nota do nome efetivo do arquivo no c√≥digo.

**Pr√≥ximos Passos**
- Validar a chamada de an√°lise na UI (`app/reports/page.tsx`) com diferentes per√≠odos: 7 dias, 30 dias e customizado.
- Conferir mensagens de erro amig√°veis para per√≠odos sem refei√ß√µes (o endpoint j√° retorna 404 com mensagem adequada).
- Confirmar presen√ßa de `GEMINI_API_KEY` no ambiente para a gera√ß√£o da an√°lise.

---

## üöÄ Pr√≥xima Implementa√ß√£o ‚Äî Feature #2: Local da refei√ß√£o + Restaurantes

**Resumo**
- Adicionar captura do local da refei√ß√£o (casa/fora) e permitir selecionar/auto-completar restaurante quando for ‚Äúfora‚Äù.
- Exibir o local no hist√≥rico e relat√≥rios.

**Impacto**: M√©dio

**Depend√™ncias**: üî¥ Migra√ß√£o #1 (tabela `restaurants`) e üî¥ Migra√ß√£o #2 (campos em `meals`).

**Plano T√©cnico (alto n√≠vel)**
- Banco de Dados (executar manualmente no Supabase):
  - Criar `restaurants` (com √≠ndices para `tenant_id` e `name`).
  - Adicionar `location_type` (home|out) e `restaurant_id` em `meals` com √≠ndices.
- Backend:
  - `lib/db/restaurants.ts`: CRUD b√°sico (listagem/insert simples, com `tenant_id`).
  - `app/api/restaurants/route.ts`: GET (lista b√°sica por popularidade/uso), POST (criar restaurante).
  - `app/api/restaurants/search/route.ts`: GET `?q=...` para autocomplete por nome (limit 10, ordenado por similaridade/usage_count se existir).
  - Ajustar `app/api/meals/route.ts` (ou fluxo de cria√ß√£o existente) para aceitar `location_type` e `restaurant_id`.
- UI/UX:
  - `app/capture/page.tsx`: adicionar escolha ‚ÄúLocal: Casa | Fora‚Äù e, se ‚ÄúFora‚Äù, input com autocomplete de restaurantes.
  - Hist√≥rico/Relat√≥rios: exibir √≠cone/label do local e, se houver, o nome do restaurante.

**Crit√©rios de Aceite**
- √â poss√≠vel salvar refei√ß√£o com `location_type = home` sem restaurante.
- √â poss√≠vel salvar refei√ß√£o com `location_type = out` e um `restaurant_id` v√°lido do tenant.
- Autocomplete retorna resultados do tenant (multi-tenant OK) e n√£o vaza dados entre tenants.
- Hist√≥rico e relat√≥rios exibem o local corretamente.
- Todas as queries protegem por `tenant_id` e usam par√¢metros.

**Notas**
- As se√ß√µes de migra√ß√£o nesta doc usam exemplos com tipos inteiros em alguns trechos; a base atual opera com UUID. Ao aplicar no Supabase, ajustar os tipos para UUID conforme o padr√£o do projeto (sem remover este conte√∫do existente).

**Pr√≥ximos passos operacionais**
1) Aprovar execu√ß√£o das Migra√ß√µes #1 e #2 no Supabase (com UUID conforme padr√£o atual).
2) Implementar endpoints e CRUD de restaurantes.
3) Integrar UI de local na captura e exibi√ß√£o no hist√≥rico/relat√≥rios.
4) Testar fluxo completo por tenant (incluindo RLS, se aplic√°vel).

---

## üîß Atualiza√ß√£o de 16/10/2025 ‚Äî Progresso Feature #2 (Local/Restaurantes)

**Status**: Em andamento

**Migra√ß√µes**
- ‚úÖ Executadas pelo operador: Migra√ß√£o #1 (restaurants) e #2 (location_type/restaurant_id em meals), com `restaurant_id` em UUID.

**Backend**
- ‚úÖ `app/api/restaurants/route.ts` ‚Äî GET lista por tenant; POST cria√ß√£o com `tenant_id`.
- ‚úÖ `app/api/restaurants/search/route.ts` ‚Äî GET `?q=` com filtro `ILIKE` por tenant.
- ‚úÖ `lib/db/restaurants.ts` ‚Äî Fun√ß√µes `createRestaurant`, `listRestaurants`, `searchRestaurants`.
- ‚úÖ `app/api/meals/approve/route.ts` ‚Äî Aceita `location_type` e `restaurant_id` (valida obrigatoriedade de restaurante quando `location_type = 'out'`).
- ‚úÖ `lib/repos/meal.repo.ts` ‚Äî Insert inclui `location_type` e `restaurant_id`; query de listagem agrega `restaurant_name` via `LEFT JOIN`.

**Frontend**
- ‚úÖ `app/capture/page.tsx` ‚Äî UI para selecionar local (Casa/Fora) e autocomplete de restaurante; payload inclui `location_type` e `restaurant_id`.
- ‚úÖ `components/CalendarView.tsx` ‚Äî Exibe chip do local (üè† Casa ou üçΩÔ∏è Nome do restaurante) nas refei√ß√µes do dia.
- ‚úÖ `app/reports/page.tsx` ‚Äî Resumo de locais (contagem casa/fora) e top restaurantes.
- ‚úÖ `app/restaurants/page.tsx` ‚Äî P√°gina com listagem e cadastro r√°pido de restaurantes; acesso via menu ‚ÄúRestaurantes‚Äù.
- ‚úÖ `components/AppLayout.tsx` ‚Äî Adicionado item de menu ‚ÄúRestaurantes‚Äù.
- ‚úÖ Pr√©-an√°lise da IA recebe o contexto de local (casa/fora e nome do restaurante, se houver) nos endpoints `analyze-text` e `analyze-image`.
- ‚úÖ `app/history/page.tsx` ‚Äî Tipos atualizados para campos opcionais de local.

**Pend√™ncias UX (opcional)**
- [ ] Bot√£o ‚ÄúCadastrar restaurante‚Äù direto do autocomplete quando n√£o houver resultados.
- [ ] Resumo por local na p√°gina de Relat√≥rios (`/app/reports/page.tsx`).
  
  Observa√ß√£o: o fluxo de captura j√° oferece o bot√£o ‚Äú‚ûï Cadastrar "<consulta>"‚Äù quando n√£o h√° resultados; podemos evoluir com captura de endere√ßo opcional.

---

## ‚úÖ Atualiza√ß√£o de 16/10/2025 ‚Äî Conclus√£o (base) da Feature #2

**Resumo do que foi conclu√≠do agora**
- Menu superior ‚ÄúRestaurantes‚Äù adicionado e p√°gina dedicada criada (`/restaurants`) com listagem e cadastro r√°pido (nome obrigat√≥rio, endere√ßo opcional).
- Na captura (Foto e Texto), o ‚Äúüìç Local da Refei√ß√£o‚Äù vem ANTES da an√°lise de IA; o contexto (casa/fora e nome do restaurante) √© enviado aos endpoints `analyze-text`/`analyze-image` e incorporado no prompt da IA.
- Autocomplete de restaurante com fallback: se n√£o houver resultados, √© oferecido ‚Äú‚ûï Cadastrar "consulta"‚Äù e o item √© criado e selecionado imediatamente.
- Salvamento de refei√ß√µes com `location_type` e `restaurant_id` (obrigat√≥rio quando `out`), exibidos no Hist√≥rico e considerados nos Relat√≥rios.

**Arquivos principais tocados (resumo)**
- Navega√ß√£o: `components/AppLayout.tsx` (menu ‚ÄúRestaurantes‚Äù).
- P√°gina: `app/restaurants/page.tsx` (listagem + cadastro r√°pido).
- APIs: `app/api/restaurants/*`, `app/api/meals/approve/route.ts`, `app/api/meals/analyze-*`.
- Dom√≠nios: `lib/db/restaurants.ts`, `lib/repos/meal.repo.ts`, `lib/schemas/meal.ts`, `lib/ai.ts`.
- UI: `app/capture/page.tsx`, `app/history/page.tsx`, `components/CalendarView.tsx`, `app/reports/page.tsx`.

**Status**
- Consideramos a Feature #2 implementada na sua vers√£o base (CRUD + UI + integra√ß√£o com IA e salvamento). Pr√≥ximos incrementos poss√≠veis permanecem listados em ‚ÄúPend√™ncias UX (opcional)‚Äù.

**Checklist r√°pido (seguran√ßa e multi-tenant)**
- Queries protegidas por `tenant_id` e parametrizadas (inclui `set_config('app.tenant_id', ...)` quando aplic√°vel).
- Sem vazamento entre tenants em listagem/autocomplete.
- Mensagens de erro em PT-BR e valida√ß√µes m√≠nimas.
